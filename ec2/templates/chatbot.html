{% extends "base.html" %}

{% block title %}AI ì—¬í–‰ ë„ìš°ë¯¸ (Powered by Google Gemini){% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- ì±„íŒ… ì˜ì—­ -->
            <div class="card chat-container">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-robot"></i> AI ì—¬í–‰ ë„ìš°ë¯¸
                        <span class="badge bg-success ms-2" id="status">Google Gemini ì—°ê²°ë¨</span>
                        <small class="d-block mt-1 opacity-75">Powered by Google Gemini AI</small>
                    </h5>
                </div>
                <div class="card-body p-0 chat-body">
                    <div id="chat-messages" class="chat-messages">
                        <!-- ì´ˆê¸° ë©”ì‹œì§€ -->
                        <div class="message bot-message">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” Google Gemini AIë¡œ êµ¬ë™ë˜ëŠ” ì—¬í–‰ ì „ë¬¸ ë„ìš°ë¯¸ì…ë‹ˆë‹¤! ğŸ¤–âœ¨<br><br>
                                    
                                    <strong>ë‹¤ìŒê³¼ ê°™ì€ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”:</strong>
                                    <div class="feature-grid mt-3">
                                        <div class="feature-item">
                                            ğŸš„ <strong>êµí†µí¸ ì •ë³´</strong><br>
                                            <small>KTX, SRT, ê³ ì†ë²„ìŠ¤, í•­ê³µí¸</small>
                                        </div>
                                        <div class="feature-item">
                                            ğŸ¨ <strong>ìˆ™ë°• & ë§›ì§‘</strong><br>
                                            <small>ì§€ì—­ë³„ ë§ì¶¤ ì¶”ì²œ</small>
                                        </div>
                                        <div class="feature-item">
                                            ğŸ—ºï¸ <strong>ì—¬í–‰ ì½”ìŠ¤</strong><br>
                                            <small>ì¼ì • ê³„íš ë° ë£¨íŠ¸ ì•ˆë‚´</small>
                                        </div>
                                        <div class="feature-item">
                                            ğŸ’° <strong>ì˜ˆì‚° ê³„íš</strong><br>
                                            <small>ë¹„ìš© ê³„ì‚° ë° ì ˆì•½ íŒ</small>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 p-2 bg-light rounded">
                                        ğŸ’¡ <strong>íŒ:</strong> êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í• ìˆ˜ë¡ ë” ì •í™•í•œ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”!<br>
                                        ì˜ˆ: "ì„œìš¸ì—ì„œ ë¶€ì‚°ê¹Œì§€ ë‚´ì¼ ì˜¤ì „ì— ê°€ë ¤ê³  í•˜ëŠ”ë° ì–´ë–¤ êµí†µí¸ì´ ì¢‹ì„ê¹Œìš”?"
                                    </div>
                                </div>
                                <div class="message-time">ë°©ê¸ˆ ì „</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" 
                               placeholder="ì—¬í–‰ ê´€ë ¨ ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ í•´ë³´ì„¸ìš”... (ì˜ˆ: ì œì£¼ë„ 3ë°•4ì¼ ê³„íš ì§œì¤˜)" 
                               autocomplete="off" maxlength="500">
                        <button class="btn btn-primary" type="button" id="send-btn" title="ë©”ì‹œì§€ ì „ì†¡">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="text-muted small">
                            <span id="char-count">0</span>/500ì
                        </div>
                        <div class="text-muted small" id="ai-status">
                            <i class="fas fa-magic"></i> AI ì¤€ë¹„ ì™„ë£Œ
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- ë¹ ë¥¸ ì§ˆë¬¸ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-lightning-bolt"></i> ì¸ê¸° ì§ˆë¬¸</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary quick-action" data-message="ì„œìš¸ì—ì„œ ë¶€ì‚°ìœ¼ë¡œ ê°€ëŠ” ê°€ì¥ ë¹ ë¥¸ êµí†µí¸ê³¼ ì†Œìš”ì‹œê°„, ê°€ê²© ì•Œë ¤ì¤˜">
                            <i class="fas fa-train"></i> ì„œìš¸â†”ë¶€ì‚° êµí†µí¸ ì™„ë²½ ê°€ì´ë“œ
                        </button>
                        <button class="btn btn-outline-success quick-action" data-message="ì œì£¼ë„ 3ë°•4ì¼ ì—¬í–‰ ê³„íšì„ ì§œì¤˜. ë Œí„°ì¹´ ì´ìš© ì˜ˆì •ì´ê³  ìì—°ê²½ê´€ê³¼ ë§›ì§‘ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì¶”ì²œí•´ì¤˜">
                            <i class="fas fa-plane"></i> ì œì£¼ë„ 3ë°•4ì¼ ì™„ë²½ ê³„íš
                        </button>
                        <button class="btn btn-outline-info quick-action" data-message="ë¶€ì‚° ì—¬í–‰ì—ì„œ ê¼­ ê°€ë´ì•¼ í•  ë§›ì§‘ 10ê³³ê³¼ ê°ê°ì˜ ëŒ€í‘œ ë©”ë‰´ ì¶”ì²œí•´ì¤˜">
                            <i class="fas fa-utensils"></i> ë¶€ì‚° ë§›ì§‘ ë² ìŠ¤íŠ¸ 10
                        </button>
                        <button class="btn btn-outline-warning quick-action" data-message="ê²¨ìš¸ì²  êµ­ë‚´ ì—¬í–‰ì§€ ì¶”ì²œí•´ì¤˜. ëˆˆ êµ¬ê²½í•˜ê³  ì˜¨ì²œë„ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ê³³ìœ¼ë¡œ">
                            <i class="fas fa-snowflake"></i> ê²¨ìš¸ ì—¬í–‰ì§€ ì¶”ì²œ
                        </button>
                        <button class="btn btn-outline-secondary quick-action" data-message="1ë°•2ì¼ êµ­ë‚´ì—¬í–‰ ì˜ˆì‚°ì„ 5ë§Œì›ìœ¼ë¡œ ì¡ê³  ìˆëŠ”ë° ê°€ëŠ¥í•œ ì—¬í–‰ì§€ì™€ ê³„íš ì¶”ì²œí•´ì¤˜">
                            <i class="fas fa-calculator"></i> ì €ì˜ˆì‚° ì—¬í–‰ ê³„íš
                        </button>
                        <button class="btn btn-outline-dark quick-action" data-message="ì—°ì¸ê³¼ í•¨ê»˜ ê°€ê¸° ì¢‹ì€ ë¡œë§¨í‹±í•œ êµ­ë‚´ ì—¬í–‰ì§€ ì¶”ì²œí•´ì¤˜">
                            <i class="fas fa-heart"></i> ì»¤í”Œ ì—¬í–‰ì§€ ì¶”ì²œ
                        </button>
                    </div>
                </div>
            </div>
            
        
            
            <!-- ìµœê·¼ ëŒ€í™” (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ) -->
            {% if current_user.is_authenticated %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-history"></i> ìµœê·¼ ëŒ€í™”</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearChatHistory()" title="ê¸°ë¡ ì‚­ì œ">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="recent-chats">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin"></i>
                            <small class="d-block mt-2">ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</small>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user-plus"></i> íšŒì› í˜œíƒ</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <i class="fas fa-star text-warning fa-2x mb-2"></i>
                        <h6>ë¡œê·¸ì¸í•˜ê³  ë” ë§ì€ ê¸°ëŠ¥ì„!</h6>
                        <ul class="list-unstyled text-start small">
                            <li><i class="fas fa-check text-success"></i> ëŒ€í™” ê¸°ë¡ ì €ì¥</li>
                            <li><i class="fas fa-check text-success"></i> ê°œì¸í™”ëœ ì¶”ì²œ</li>
                            <li><i class="fas fa-check text-success"></i> ì—¬í–‰ ê³„íš ì €ì¥</li>
                            <li><i class="fas fa-check text-success"></i> ì¦ê²¨ì°¾ê¸° ê´€ë¦¬</li>
                        </ul>
                        <div class="d-grid gap-2 mt-3">
                            <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">ë¡œê·¸ì¸</a>
                            <a href="{{ url_for('register') }}" class="btn btn-outline-primary btn-sm">íšŒì›ê°€ì…</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.chat-container {
    height: 80vh;
    display: flex;
    flex-direction: column;
    min-height: 600px;
}

.chat-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    background-attachment: fixed;
    max-height: calc(80vh - 120px);
}

.message {
    display: flex;
    margin-bottom: 20px;
    align-items: flex-start;
    animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 20px;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.bot-message .message-avatar {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.user-message {
    flex-direction: row-reverse;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #ffeaa7, #fab1a0);
    color: #2d3436;
    margin-left: 12px;
    margin-right: 0;
}

.message-content {
    max-width: 75%;
    min-width: 120px;
}

.user-message .message-content {
    text-align: right;
}

.message-bubble {
    background: rgba(255, 255, 255, 0.95);
    padding: 15px 20px;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    word-wrap: break-word;
    position: relative;
    backdrop-filter: blur(10px);
}

.user-message .message-bubble {
    background: linear-gradient(135deg, #74b9ff, #0984e3);
    color: white;
}

.message-bubble::before {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    border: 10px solid transparent;
}

.bot-message .message-bubble::before {
    left: -18px;
    top: 20px;
    border-right-color: rgba(255, 255, 255, 0.95);
}

.user-message .message-bubble::before {
    right: -18px;
    top: 20px;
    border-left-color: #74b9ff;
}

.message-time {
    font-size: 11px;
    color: #636e72;
    margin-top: 8px;
    font-weight: 500;
}

.user-message .message-time {
    text-align: right;
}

.feature-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.feature-item {
    background: rgba(116, 185, 255, 0.1);
    padding: 8px;
    border-radius: 8px;
    font-size: 12px;
    text-align: center;
}

.typing-indicator {
    display: none;
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    margin-bottom: 15px;
    width: fit-content;
    backdrop-filter: blur(10px);
}

.typing-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    margin: 0 3px;
    animation: typingPulse 1.5s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typingPulse {
    0%, 60%, 100% {
        transform: scale(1);
        opacity: 0.7;
    }
    30% {
        transform: scale(1.2);
        opacity: 1;
    }
}

.ai-info .info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px solid #f1f3f4;
}

.ai-info .info-item:last-child {
    border-bottom: none;
}

.recent-chat-item {
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    margin-bottom: 8px;
}

.recent-chat-item:hover {
    background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
    border-color: #667eea;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
}

.recent-chat-item span {
    font-size: 13px;
    color: #2d3436;
    font-weight: 500;
}

#message-input {
    border: 2px solid #ddd;
    border-radius: 25px;
    padding: 12px 20px;
    font-size: 14px;
}

#message-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.quick-action {
    transition: all 0.3s ease;
    border-radius: 12px;
    padding: 12px;
    text-align: left;
    font-size: 13px;
}

.quick-action:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.quick-action i {
    margin-right: 8px;
    width: 20px;
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    overflow: hidden;
}

.card-header {
    border-bottom: 1px solid rgba(255,255,255,0.2);
    font-weight: 600;
}

.card-footer {
    background: rgba(255, 255, 255, 0.95);
    border-top: 1px solid #e9ecef;
    backdrop-filter: blur(10px);
    flex-shrink: 0;
}

#char-count {
    font-weight: 600;
}

.char-warning {
    color: #f39c12 !important;
}

.char-danger {
    color: #e74c3c !important;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #2ecc71;
    margin-right: 5px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
    }
}

/* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
.chat-messages::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a6fd8, #6a4190);
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .chat-container {
        height: 70vh;
        min-height: 500px;
    }
    
    .chat-messages {
        max-height: calc(70vh - 120px);
    }
    
    .message-content {
        max-width: 85%;
    }
    
    .chat-messages {
        padding: 15px;
    }
    
    .feature-grid {
        grid-template-columns: 1fr;
    }
    
    .quick-action {
        font-size: 12px;
        padding: 10px;
    }
}

/* ë‹¤í¬ ëª¨ë“œ ì§€ì› */
@media (prefers-color-scheme: dark) {
    .chat-messages {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    }
    
    .message-bubble {
        background: rgba(44, 62, 80, 0.9);
        color: #ecf0f1;
    }
    
    .feature-item {
        background: rgba(52, 73, 94, 0.3);
        color: #ecf0f1;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ì „ì—­ ë³€ìˆ˜
let chatHistory = [];
let isTyping = false;
let aiConnected = true;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    updateStatus('ì—°ê²°ë¨');
    loadRecentChats();
    
    // ì´ˆê¸° ë©”ì‹œì§€ ìŠ¤í¬ë¡¤
    setTimeout(scrollToBottom, 100);
});

function setupEventListeners() {
    // ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼
    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // ë©”ì‹œì§€ ì…ë ¥ í•„ë“œ
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        // ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // ê¸€ì ìˆ˜ ì¹´ìš´í„°
        messageInput.addEventListener('input', updateCharCount);
    }
    
    // ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤
    document.querySelectorAll('.quick-action').forEach(button => {
        button.addEventListener('click', function() {
            const message = this.getAttribute('data-message');
            if (messageInput && message) {
                messageInput.value = message;
                updateCharCount();
                sendMessage();
            }
        });
    });
    
    // ìµœê·¼ ëŒ€í™” í´ë¦­ ì´ë²¤íŠ¸
    document.addEventListener('click', function(e) {
        const recentChatItem = e.target.closest('.recent-chat-item');
        if (recentChatItem && messageInput) {
            const messageElement = recentChatItem.querySelector('span');
            if (messageElement) {
                const message = messageElement.textContent.trim();
                messageInput.value = message;
                updateCharCount();
                sendMessage();
            }
        }
    });
}

function updateCharCount() {
    const input = document.getElementById('message-input');
    const counter = document.getElementById('char-count');
    
    if (!input || !counter) return;
    
    const length = input.value.length;
    counter.textContent = length;
    
    // ê¸€ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    counter.className = '';
    if (length > 400) {
        counter.classList.add('char-danger');
    } else if (length > 300) {
        counter.classList.add('char-warning');
    }
}

function sendMessage() {
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;
    
    const message = messageInput.value.trim();
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!message) {
        showNotification('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    if (isTyping) {
        return;
    }
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    messageInput.value = '';
    updateCharCount();
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    appendMessage(message, 'user');
    
    // ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€ (ë©”ëª¨ë¦¬ì—)
    addToChatHistory('user', message);
    
    // AI ì‘ë‹µ ìš”ì²­
    getAIResponse(message);
}

function appendMessage(message, sender) {
    const timestamp = new Date().toLocaleTimeString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const messageClass = sender === 'user' ? 'user-message' : 'bot-message';
    const avatarIcon = sender === 'user' ? 'fa-user' : 'fa-robot';
    
    // HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
    const safeMessage = message.replace(/&/g, '&amp;')
                             .replace(/</g, '&lt;')
                             .replace(/>/g, '&gt;')
                             .replace(/"/g, '&quot;')
                             .replace(/'/g, '&#39;')
                             .replace(/\n/g, '<br>');
    
    const messageHTML = `
        <div class="message ${messageClass}">
            <div class="message-avatar">
                <i class="fas ${avatarIcon}"></i>
            </div>
            <div class="message-content">
                <div class="message-bubble">
                    ${safeMessage}
                </div>
                <div class="message-time">${timestamp}</div>
            </div>
        </div>
    `;
    
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.insertAdjacentHTML('beforeend', messageHTML);
        scrollToBottom();
    }
}

function getAIResponse(message) {
    showTypingIndicator();
    updateAIStatus('AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘...');
    
    fetch('/api/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideTypingIndicator();
        updateAIStatus('AI ì¤€ë¹„ ì™„ë£Œ');
        
        if (data.success && data.response) {
            appendMessage(data.response, 'bot');
            addToChatHistory('bot', data.response);
            updateStatus('ì—°ê²°ë¨');
            aiConnected = true;
        } else {
            const errorMsg = data.response || 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            appendMessage(errorMsg, 'bot');
            updateStatus('ì˜¤ë¥˜');
        }
        
        // ìµœê·¼ ëŒ€í™” ëª©ë¡ ì—…ë°ì´íŠ¸
        setTimeout(loadRecentChats, 1000);
    })
    .catch(error => {
        hideTypingIndicator();
        updateAIStatus('ì—°ê²° ì˜¤ë¥˜');
        console.error('AI ì‘ë‹µ ì˜¤ë¥˜:', error);
        
        let errorMessage = 'ì£„ì†¡í•©ë‹ˆë‹¤. ';
        if (error.message.includes('Failed to fetch')) {
            errorMessage += 'AI ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            updateStatus('ì—°ê²° ëŠê¹€');
        } else {
            errorMessage += 'AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            updateStatus('ì˜¤ë¥˜');
        }
        
        appendMessage(errorMessage, 'bot');
        aiConnected = false;
        
        // 5ì´ˆ í›„ ì—°ê²° ì¬ì‹œë„
        setTimeout(() => {
            updateAIStatus('ì¬ì—°ê²° ì‹œë„ ì¤‘...');
            checkAIStatus();
        }, 5000);
    });
}

function showTypingIndicator() {
    isTyping = true;
    
    const typingHTML = `
        <div class="message bot-message typing-indicator">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-bubble">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            </div>
        </div>
    `;
    
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.insertAdjacentHTML('beforeend', typingHTML);
        const typingIndicator = document.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.style.display = 'flex';
        }
        scrollToBottom();
    }
}

function hideTypingIndicator() {
    isTyping = false;
    const typingIndicator = document.querySelector('.typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function checkAIStatus() {
    const button = event?.target?.closest('button');
    if (button) {
        const icon = button.querySelector('i');
        const originalClass = icon.className;
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìŠ¤í”¼ë„ˆ í‘œì‹œ
        button.disabled = true;
        icon.className = 'fas fa-spinner fa-spin';
        
        // ê°„ë‹¨í•œ ìƒíƒœ í™•ì¸ ë©”ì‹œì§€ ì „ì†¡
        fetch('/api/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: 'ì•ˆë…•' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatus('ì—°ê²°ë¨');
                showNotification('AIê°€ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                aiConnected = true;
            } else {
                updateStatus('ì˜¤ë¥˜');
                showNotification('AI ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.', 'error');
                aiConnected = false;
            }
        })
        .catch(error => {
            updateStatus('ì—°ê²° ëŠê¹€');
            showNotification('AI ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            aiConnected = false;
        })
        .finally(() => {
            // ë²„íŠ¼ ë³µì›
            if (button) {
                button.disabled = false;
                icon.className = originalClass;
            }
        });
    }
}

function loadRecentChats() {
    // Jinja2ê°€ ë Œë”ë§ ì‹œì ì— true/falseë¡œ ë°”ê¿”ì¤Œ
    var isAuthenticated = "{{ 'true' if current_user.is_authenticated else 'false' }}";
    if (isAuthenticated !== "true") return;

    fetch('/api/chat_history')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('recent-chats');
        if (!container) return;
        
        if (data.success && data.history.length > 0) {
            const recentChatsHTML = data.history.slice(-5).reverse().map(chat => {
                return `
                    <div class="recent-chat-item">
                        <small class="text-muted">${chat.timestamp}</small><br>
                        <span>${chat.message.substring(0, 40)}${chat.message.length > 40 ? '...' : ''}</span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = recentChatsHTML;
        } else {
            container.innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-comments text-muted"></i>
                    <small class="d-block mt-2">ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</small>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('ì±„íŒ… ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

function addToChatHistory(sender, message) {
    const timestamp = new Date().toISOString();
    chatHistory.push({ sender, message, timestamp });
    
    // ìµœëŒ€ 50ê°œ ë©”ì‹œì§€ë§Œ ì €ì¥ (ë©”ëª¨ë¦¬ ì ˆì•½)
    if (chatHistory.length > 50) {
        chatHistory = chatHistory.slice(-50);
    }
}

function clearChatHistory() {
    if (confirm('ì±„íŒ… ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ì„¸ì…˜ì˜ ë©”ëª¨ë¦¬ ê¸°ë¡ë§Œ ì‚­ì œë©ë‹ˆë‹¤)')) {
        chatHistory = [];
        showNotification('í˜„ì¬ ì„¸ì…˜ì˜ ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        
        // ëŒ€í™”ì°½ì— ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
        appendMessage('í˜„ì¬ ì„¸ì…˜ì˜ ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ˜Š', 'bot');
    }
}

function updateStatus(status) {
    const statusElement = document.getElementById('status');
    if (statusElement) {
        let statusText, statusClass;
        
        switch(status) {
            case 'ì—°ê²°ë¨':
                statusText = 'Google Gemini ì—°ê²°ë¨';
                statusClass = 'badge bg-success ms-2';
                break;
            case 'ì—°ê²° ëŠê¹€':
                statusText = 'ì—°ê²° ëŠê¹€';
                statusClass = 'badge bg-danger ms-2';
                break;
            case 'ì˜¤ë¥˜':
                statusText = 'ì˜¤ë¥˜ ë°œìƒ';
                statusClass = 'badge bg-warning ms-2';
                break;
            default:
                statusText = status;
                statusClass = 'badge bg-secondary ms-2';
        }
        
        statusElement.textContent = statusText;
        statusElement.className = statusClass;
    }
}

function updateAIStatus(status) {
    const aiStatus = document.getElementById('ai-status');
    if (aiStatus) {
        aiStatus.textContent = status;
    }
}

function showNotification(message, type = 'info') {
    // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ì•Œë¦¼ ìƒì„±
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

// ì—ëŸ¬ ì²˜ë¦¬
window.addEventListener('error', function(e) {
    console.error('JavaScript ì˜¤ë¥˜:', e.error);
});

// ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
if (!window.fetch) {
    showNotification('ì´ ë¸Œë¼ìš°ì €ëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìµœì‹  ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
}

// ì£¼ê¸°ì  ìƒíƒœ í™•ì¸ (5ë¶„ë§ˆë‹¤)
setInterval(() => {
    if (!aiConnected) {
        checkAIStatus();
    }
}, 300000);
</script>
{% endblock %}